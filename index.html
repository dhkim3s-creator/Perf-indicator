<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>[2-1] ì–¼ë¦¬ë²„ë“œ ì·¨ì—…ì§€ì› ì‚¬ì—…ì‹¤ì ê´€ë¦¬</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel (JSX -> JS in browser) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Firebase (Compat SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; }
  </style>
</head>

<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useRef, useEffect } = React;

    // =========================
    // Firebase ì´ˆê¸°í™”
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDp5-SjGHdLRQ7feRoS-RdKsJI4QFUJKQ0",
      authDomain: "perf-indicator.firebaseapp.com",
      databaseURL: "https://perf-indicator-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "perf-indicator",
      storageBucket: "perf-indicator.firebasestorage.app",
      messagingSenderId: "425708194902",
      appId: "1:425708194902:web:1bd90a680999b8791b3ff7",
      measurementId: "G-8LBV6RBRJP"
    };

    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        try { firebase.analytics(); } catch (e) {}
      }
    } catch (e) {
      console.error("Firebase init error:", e);
    }

    const db = firebase.database();
    const DB_PATH = "earlyBirdManager/v2"; // âœ… v2ë¡œ ê³ ì •(êµ¬ë²„ì „ ë°ì´í„°ë„ ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜)

    // =========================
    // ìœ í‹¸
    // =========================
    const todayISO = () => new Date().toISOString().split('T')[0];

    const parseNumberLike = (v) => {
      if (v === null || v === undefined) return 0;
      const s = String(v).replace(/[^\d.-]/g, '');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };

    const safeText = (v, fallback = '') => {
      const s = (v ?? '').toString();
      return s.trim().length ? s : fallback;
    };

    const newId = () => Date.now() + Math.floor(Math.random() * 1000);

    // Lucide Icon
    function Icon({ name, className }) {
      return <i data-lucide={name} className={className}></i>;
    }

    // =========================
    // ì´ˆê¸° ë°ì´í„°(ì •ìƒ ê¸°ì¤€)
    // =========================
    // [ì§€ìì²´] ì„±ê³¼ëª©í‘œ ë‹¬ì„±ìœ¨ (ì—…ë¡œë“œ í‘œ ê¸°ë°˜ ë¶„ë¥˜)
    const INITIAL_MUNICIPAL = [
      // ìº¡ìŠ¤í†¤/í˜„ì¥ì‹¤ìŠµ ì´ìˆ˜í•™ìƒ ìˆ˜ (ì„¸ë¶€ ë¶„ë¥˜)
      { id: 101, group: "ì§€ìì²´", indicatorName: "ìº¡ìŠ¤í†¤ë””ìì¸ ë° í˜„ì¥ì‹¤ìŠµ ì´ìˆ˜í•™ìƒ ìˆ˜", subItem: "í•©ê³„", unit: "ëª…", baseline: 1058, target: 1111, sem1: 886, sem2: 270 },
      { id: 102, group: "ì§€ìì²´", indicatorName: "ìº¡ìŠ¤í†¤ë””ìì¸ ë° í˜„ì¥ì‹¤ìŠµ ì´ìˆ˜í•™ìƒ ìˆ˜", subItem: "ì†Œê³„(ìº¡ìŠ¤í†¤ë””ìì¸)", unit: "ëª…", baseline: 820, target: 861, sem1: 557, sem2: 0 },
      { id: 103, group: "ì§€ìì²´", indicatorName: "ìº¡ìŠ¤í†¤ë””ìì¸ ë° í˜„ì¥ì‹¤ìŠµ ì´ìˆ˜í•™ìƒ ìˆ˜", subItem: "ê¸°ì—…ì—°ê³„", unit: "ëª…", baseline: 322, target: 338, sem1: 229, sem2: 0 },
      { id: 104, group: "ì§€ìì²´", indicatorName: "ìº¡ìŠ¤í†¤ë””ìì¸ ë° í˜„ì¥ì‹¤ìŠµ ì´ìˆ˜í•™ìƒ ìˆ˜", subItem: "ì¼ë°˜", unit: "ëª…", baseline: 498, target: 523, sem1: 328, sem2: 0 },
      { id: 105, group: "ì§€ìì²´", indicatorName: "ìº¡ìŠ¤í†¤ë””ìì¸ ë° í˜„ì¥ì‹¤ìŠµ ì´ìˆ˜í•™ìƒ ìˆ˜", subItem: "ì†Œê³„(í˜„ì¥ì‹¤ìŠµ)", unit: "ëª…", baseline: 238, target: 250, sem1: 345, sem2: 254 },
      { id: 106, group: "ì§€ìì²´", indicatorName: "ìº¡ìŠ¤í†¤ë””ìì¸ ë° í˜„ì¥ì‹¤ìŠµ ì´ìˆ˜í•™ìƒ ìˆ˜", subItem: "í‘œì¤€í˜•", unit: "ëª…", baseline: 62, target: 65, sem1: 55, sem2: 28 },
      { id: 107, group: "ì§€ìì²´", indicatorName: "ìº¡ìŠ¤í†¤ë””ìì¸ ë° í˜„ì¥ì‹¤ìŠµ ì´ìˆ˜í•™ìƒ ìˆ˜", subItem: "ê¸°íƒ€(ììœ¨ ë° ì˜ë¬´í˜•)", unit: "ëª…", baseline: 176, target: 185, sem1: 290, sem2: 226 },

      // ëŒ€ì „í˜• 360Â°ì¸ì¬ ì§€ì—­ ì •ì£¼ ì·¨ì—…ì ìˆ˜
      { id: 201, group: "ì§€ìì²´", indicatorName: "ëŒ€ì „í˜• 360Â°ì¸ì¬ ì§€ì—­ ì •ì£¼ ì·¨ì—…ì ìˆ˜", subItem: "í•©ê³„", unit: "ëª…", baseline: 1081, target: 1135, sem1: 0, sem2: 0 },
      { id: 202, group: "ì§€ìì²´", indicatorName: "ëŒ€ì „í˜• 360Â°ì¸ì¬ ì§€ì—­ ì •ì£¼ ì·¨ì—…ì ìˆ˜", subItem: "ì§€ì—­ ë‚´", unit: "ëª…", baseline: 275, target: 289, sem1: 0, sem2: 0 },
      { id: 203, group: "ì§€ìì²´", indicatorName: "ëŒ€ì „í˜• 360Â°ì¸ì¬ ì§€ì—­ ì •ì£¼ ì·¨ì—…ì ìˆ˜", subItem: "ì§€ì—­ ì™¸", unit: "ëª…", baseline: 700, target: 735, sem1: 0, sem2: 0 },
      { id: 204, group: "ì§€ìì²´", indicatorName: "ëŒ€ì „í˜• 360Â°ì¸ì¬ ì§€ì—­ ì •ì£¼ ì·¨ì—…ì ìˆ˜", subItem: "ê¸°íƒ€", unit: "ëª…", baseline: 106, target: 111, sem1: 0, sem2: 0 },
    ];

    // [ëŒ€í•™] ììœ¨ì„±ê³¼ì§€í‘œ
    const INITIAL_UNIV = [
      { id: 301, group: "ëŒ€í•™", indicatorName: "ìº¡ìŠ¤í†¤/í˜„ì¥ì‹¤ìŠµ ì—°ê³„ ë¹„êµê³¼ ì´ìˆ˜í•™ìƒ ìˆ˜", subItem: "-", unit: "ëª…", baseline: 256, target: 270, sem1: 177, sem2: 0 },
      { id: 302, group: "ëŒ€í•™", indicatorName: "í‘œì¤€í˜„ì¥ì‹¤ìŠµ í•™ê¸°ì œ ì´ìˆ˜í•™ìƒ ì·¨ì—…ë¥ ", subItem: "-", unit: "%", baseline: 36.8, target: 0, sem1: 0, sem2: 0 },
    ];

    const INITIAL_TASKS = [
      { id: 1, category: 'ì·¨ì—…ì§€ì›ì„¼í„°', name: 'RISE ê¸°ë°˜ AI ì¡ë§¤ì¹­ í”Œë«í¼ ê°œë°œ', schedule: '2025.06~2026.02', status: 'In Progress', note: 'ì—…ì²´ì„ ì •ì™„ë£Œ ë° ê°œë°œ ì¤‘' },
      { id: 2, category: 'ì·¨ì—…ì§€ì›ì„¼í„°', name: 'RISE ê¸°ë°˜ 4i ICC í˜„ì¥ ì¤‘ì‹¬ ì·¨ì—…ì§€ì›', schedule: '2025.06~2026.02', status: 'In Progress', note: 'ë‹¨ëŒ€ë³„ 6ê°œê³¼ëª© êµìœ¡ì§„í–‰' },
      { id: 3, category: 'ì·¨ì—…ì§€ì›ì„¼í„°', name: 'RISE ê¸°ë°˜ 4i ICC ì‹¤ì „ ì·¨ì—… ì§€ì›', schedule: '2025.06~2026.02', status: 'Completed', note: '4ê°œ ë‹¨ëŒ€ë³„ ì·¨ì—…ë°•ëŒíšŒ ì™„ë£Œ' },
      { id: 4, category: 'ìº¡ìŠ¤í†¤ë””ìì¸', name: 'ìƒë°˜ê¸° ìº¡ìŠ¤í†¤ ë””ìì¸ ê²½ì§„ëŒ€íšŒ', schedule: '2025.06', status: 'Completed', note: '1í•™ê¸° ê²½ì§„ëŒ€íšŒ ì™„ë£Œ' },
      { id: 5, category: 'ìº¡ìŠ¤í†¤ë””ìì¸', name: 'ì§€ì—­ë°œêµ´ ì—°ê³„í˜‘ì—…ì²´ê³„êµ¬ì¶•', schedule: '2025.07~12', status: 'Planned', note: 'ì§€ì—­ì—°ê³„ ê¸°ì—…ì²´ ë°œêµ´' },
      { id: 6, category: 'í‘œì¤€í˜„ì¥ì‹¤ìŠµ', name: 'ì—¬ë¦„í•™ê¸° í˜„ì¥ì‹¤ìŠµìƒ ë³´í—˜ê°€ì… ë° ì§€ì›', schedule: '2025.06~08', status: 'Completed', note: '' },
      { id: 7, category: 'í‘œì¤€í˜„ì¥ì‹¤ìŠµ', name: 'í‘œì¤€í˜„ì¥ì‹¤ìŠµ ê²½ì§„ëŒ€íšŒ', schedule: '2025.11~12', status: 'Planned', note: 'í†µí•© ê²½ì§„ëŒ€íšŒ ì‹¤ì‹œ' },
    ];

    const INITIAL_BUDGET = {
      total: 665000,     // ì²œì›
      executed: 334229,  // ì²œì›
      details: [
        { id: 1, item: 'ì–¼ë¦¬ë²„ë“œ ì·¨ì—…ì§€ì› ìš´ì˜ë¹„', amount: 334229, date: '2025-06-30', type: 'ì§‘í–‰' }
      ]
    };

    // =========================
    // êµ¬ë²„ì „ ë°ì´í„° â†’ v2 ë§ˆì´ê·¸ë ˆì´ì…˜
    // =========================
    function migrateIfNeeded(raw) {
      // ì´ë¯¸ v2 êµ¬ì¡°ë©´ ê·¸ëŒ€ë¡œ
      if (raw && (Array.isArray(raw.municipalIndicators) || Array.isArray(raw.univIndicators))) {
        const municipal = Array.isArray(raw.municipalIndicators) && raw.municipalIndicators.length ? raw.municipalIndicators : INITIAL_MUNICIPAL;
        const univ = Array.isArray(raw.univIndicators) && raw.univIndicators.length ? raw.univIndicators : INITIAL_UNIV;
        const tasks = Array.isArray(raw.tasks) && raw.tasks.length ? raw.tasks : INITIAL_TASKS;
        const budget = raw.budget && typeof raw.budget === "object" ? {
          total: parseNumberLike(raw.budget.total),
          executed: parseNumberLike(raw.budget.executed),
          details: Array.isArray(raw.budget.details) ? raw.budget.details : []
        } : INITIAL_BUDGET;

        // ë°©ì–´ ë³´ì •
        const safeExecuted = Math.max(0, parseNumberLike(budget.executed));
        const safeTotal = Math.max(parseNumberLike(budget.total), safeExecuted);
        return { municipalIndicators: municipal, univIndicators: univ, tasks, budget: { ...budget, executed: safeExecuted, total: safeTotal } };
      }

      // êµ¬ë²„ì „: indicators ë°°ì—´ì´ ìˆë˜ ê²½ìš°(ì´ì „ ëŒ€í™”ì—ì„œ ë§ì´ ë°œìƒ)
      if (raw && Array.isArray(raw.indicators)) {
        const old = raw.indicators;
        const municipal = [];
        const univ = [];

        old.forEach((x, idx) => {
          const name = safeText(x.name, safeText(x.indicatorName, `ì§€í‘œ ${idx+1}`));
          const category = safeText(x.category, "");
          const unit = safeText(x.unit, "ëª…");
          const baseline = parseNumberLike(x.baseline);
          const target = parseNumberLike(x.target);
          const sem1 = parseNumberLike(x.resultSem1);
          const sem2 = parseNumberLike(x.resultSem2);

          const row = {
            id: parseNumberLike(x.id) || newId(),
            group: (category.includes("ììœ¨") || name.includes("ììœ¨")) ? "ëŒ€í•™" : "ì§€ìì²´",
            indicatorName: name,
            subItem: safeText(x.subItem, "-"),
            unit, baseline, target, sem1, sem2
          };

          if (row.group === "ëŒ€í•™") univ.push(row);
          else municipal.push(row);
        });

        const tasks = Array.isArray(raw.tasks) && raw.tasks.length ? raw.tasks : INITIAL_TASKS;
        const budget = raw.budget && typeof raw.budget === "object" ? {
          total: parseNumberLike(raw.budget.total),
          executed: parseNumberLike(raw.budget.executed),
          details: Array.isArray(raw.budget.details) ? raw.budget.details : []
        } : INITIAL_BUDGET;

        // ë¹ˆ ë°°ì—´ì´ë©´ ì´ˆê¸°ê°’ìœ¼ë¡œ ë³´ì •
        const m = municipal.length ? municipal : INITIAL_MUNICIPAL;
        const u = univ.length ? univ : INITIAL_UNIV;

        const safeExecuted = Math.max(0, parseNumberLike(budget.executed));
        const safeTotal = Math.max(parseNumberLike(budget.total), safeExecuted);

        return { municipalIndicators: m, univIndicators: u, tasks, budget: { ...budget, executed: safeExecuted, total: safeTotal } };
      }

      // ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ ì´ˆê¸°ê°’
      return { municipalIndicators: INITIAL_MUNICIPAL, univIndicators: INITIAL_UNIV, tasks: INITIAL_TASKS, budget: INITIAL_BUDGET };
    }

    // =========================
    // ë©”ì¸ ì•±
    // =========================
    function EarlyBirdManager() {
      const [activeTab, setActiveTab] = useState('dashboard');

      const [municipalIndicators, setMunicipalIndicators] = useState(INITIAL_MUNICIPAL);
      const [univIndicators, setUnivIndicators] = useState(INITIAL_UNIV);
      const [tasks, setTasks] = useState(INITIAL_TASKS);
      const [budget, setBudget] = useState(INITIAL_BUDGET);

      const [loading, setLoading] = useState(true);
      const [saveMsg, setSaveMsg] = useState('');

      // ì˜ˆì‚°: ì—°ì†ì…ë ¥ ì•ˆì • (uncontrolled)
      const expenseItemRef = useRef(null);
      const expenseAmountRef = useRef(null);

      // ì´ì˜ˆì‚° ìˆ˜ì •
      const [isEditingTotal, setIsEditingTotal] = useState(false);
      const [totalDraft, setTotalDraft] = useState(String(INITIAL_BUDGET.total));

      // ì˜ˆì‚°ë‚´ì—­ ìˆ˜ì •
      const [editingBudgetId, setEditingBudgetId] = useState(null);
      const [budgetEditDraft, setBudgetEditDraft] = useState({ date: '', item: '', amount: '' });

      // ì„¸ë¶€ê³¼ì œ CRUD (uncontrolled add)
      const taskCategoryRef = useRef(null);
      const taskNameRef = useRef(null);
      const taskScheduleRef = useRef(null);
      const taskNoteRef = useRef(null);

      const [editingTaskId, setEditingTaskId] = useState(null);
      const [taskEditDraft, setTaskEditDraft] = useState({ category: '', name: '', schedule: '', note: '' });

      // =========================
      // Firebase ë¡œë“œ
      // =========================
      useEffect(() => {
        let cancelled = false;

        (async () => {
          try {
            const snap = await db.ref(DB_PATH).get();
            let data = null;

            if (snap.exists()) {
              data = snap.val();
            } else {
              // v2ê°€ ì—†ìœ¼ë©´ êµ¬ë²„ì „(v1)ë„ í•œë²ˆ ì½ì–´ë³´ê¸°
              const snapV1 = await db.ref("earlyBirdManager/v1").get();
              if (snapV1.exists()) data = snapV1.val();
            }

            const migrated = migrateIfNeeded(data);

            if (!cancelled) {
              setMunicipalIndicators(migrated.municipalIndicators);
              setUnivIndicators(migrated.univIndicators);
              setTasks(migrated.tasks);

              setBudget(migrated.budget);
              setTotalDraft(String(parseNumberLike(migrated.budget.total)));

              setLoading(false);
            }
          } catch (e) {
            console.error("Load error:", e);
            if (!cancelled) {
              setMunicipalIndicators(INITIAL_MUNICIPAL);
              setUnivIndicators(INITIAL_UNIV);
              setTasks(INITIAL_TASKS);
              setBudget(INITIAL_BUDGET);
              setTotalDraft(String(INITIAL_BUDGET.total));
              setLoading(false);
            }
          }
        })();

        return () => { cancelled = true; };
      }, []);

      // =========================
      // ì €ì¥
      // =========================
      const saveToFirebase = async () => {
        setSaveMsg('');
        try {
          const payload = {
            municipalIndicators,
            univIndicators,
            tasks,
            budget,
            updatedAt: new Date().toISOString()
          };
          await db.ref(DB_PATH).set(payload);
          setSaveMsg('âœ… ì €ì¥ ì™„ë£Œ');
          setTimeout(() => setSaveMsg(''), 2000);
        } catch (e) {
          console.error("Save error:", e);
          setSaveMsg('âŒ ì €ì¥ ì‹¤íŒ¨ (Rules/ê¶Œí•œ í™•ì¸ í•„ìš”)');
          setTimeout(() => setSaveMsg(''), 3500);
        }
      };

      // =========================
      // ê³„ì‚°
      // =========================
      const totalBudgetRatio = useMemo(() => {
        const t = parseNumberLike(budget.total);
        const e = parseNumberLike(budget.executed);
        if (t <= 0) return "0.0";
        return ((e / t) * 100).toFixed(1);
      }, [budget]);

      const allIndicators = useMemo(() => {
        const m = Array.isArray(municipalIndicators) ? municipalIndicators : [];
        const u = Array.isArray(univIndicators) ? univIndicators : [];
        return [...m, ...u];
      }, [municipalIndicators, univIndicators]);

      const averageAchievement = useMemo(() => {
        const targets = allIndicators.filter(i => parseNumberLike(i.target) > 0);
        if (!targets.length) return "0.0";
        const sum = targets.reduce((acc, i) => {
          const total = parseNumberLike(i.sem1) + parseNumberLike(i.sem2);
          const target = parseNumberLike(i.target);
          const rate = target > 0 ? Math.min((total / target) * 100, 100) : 0;
          return acc + rate;
        }, 0);
        return (sum / targets.length).toFixed(1);
      }, [allIndicators]);

      // =========================
      // ì§€í‘œ ë³€ê²½ í•¸ë“¤ëŸ¬
      // =========================
      const updateIndicator = (group, id, field, value) => {
        const n = parseNumberLike(value);
        if (group === "ì§€ìì²´") {
          setMunicipalIndicators(prev => prev.map(r => r.id === id ? { ...r, [field]: n } : r));
        } else {
          setUnivIndicators(prev => prev.map(r => r.id === id ? { ...r, [field]: n } : r));
        }
      };

      // =========================
      // ì„¸ë¶€ê³¼ì œ: ìƒíƒœ/ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ
      // =========================
      const setTaskStatus = (id, status) => {
        setTasks(prev => prev.map(t => t.id === id ? { ...t, status } : t));
      };

      const addTask = () => {
        const category = safeText(taskCategoryRef.current?.value, '').trim();
        const name = safeText(taskNameRef.current?.value, '').trim();
        const schedule = safeText(taskScheduleRef.current?.value, '').trim();
        const note = safeText(taskNoteRef.current?.value, '').trim();

        if (!category || !name) return;

        const newTask = {
          id: newId(),
          category,
          name,
          schedule,
          status: "Planned",
          note
        };

        setTasks(prev => [newTask, ...prev]);

        // reset
        if (taskCategoryRef.current) taskCategoryRef.current.value = '';
        if (taskNameRef.current) taskNameRef.current.value = '';
        if (taskScheduleRef.current) taskScheduleRef.current.value = '';
        if (taskNoteRef.current) taskNoteRef.current.value = '';
        taskCategoryRef.current?.focus();
      };

      const startEditTask = (task) => {
        setEditingTaskId(task.id);
        setTaskEditDraft({
          category: safeText(task.category),
          name: safeText(task.name),
          schedule: safeText(task.schedule),
          note: safeText(task.note)
        });
      };

      const cancelEditTask = () => {
        setEditingTaskId(null);
        setTaskEditDraft({ category: '', name: '', schedule: '', note: '' });
      };

      const saveEditTask = () => {
        const id = editingTaskId;
        if (!id) return;

        const category = safeText(taskEditDraft.category).trim();
        const name = safeText(taskEditDraft.name).trim();
        const schedule = safeText(taskEditDraft.schedule).trim();
        const note = safeText(taskEditDraft.note).trim();

        if (!category || !name) return;

        setTasks(prev => prev.map(t => t.id === id ? { ...t, category, name, schedule, note } : t));
        cancelEditTask();
      };

      const deleteTask = (id) => {
        if (!confirm("í•´ë‹¹ ì„¸ë¶€ê³¼ì œë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
        setTasks(prev => prev.filter(t => t.id !== id));
        if (editingTaskId === id) cancelEditTask();
      };

      // =========================
      // ì˜ˆì‚°: ì´ì˜ˆì‚°/ì§‘í–‰ë‚´ì—­ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ
      // =========================
      const startEditTotal = () => {
        setTotalDraft(String(parseNumberLike(budget.total)));
        setIsEditingTotal(true);
      };

      const cancelEditTotal = () => {
        setTotalDraft(String(parseNumberLike(budget.total)));
        setIsEditingTotal(false);
      };

      const saveEditTotal = () => {
        const proposed = parseNumberLike(totalDraft);
        const executed = parseNumberLike(budget.executed);
        const safeTotal = Math.max(proposed, executed);
        setBudget(prev => ({ ...prev, total: safeTotal }));
        setTotalDraft(String(safeTotal));
        setIsEditingTotal(false);
      };

      const addExpense = () => {
        const item = (expenseItemRef.current?.value || '').trim();
        const amount = parseNumberLike(expenseAmountRef.current?.value || '');
        if (!item || amount <= 0) return;

        const newRow = { id: newId(), item, amount, date: todayISO(), type: 'ì§‘í–‰' };

        setBudget(prev => {
          const executed = parseNumberLike(prev.executed) + amount;
          const total = Math.max(parseNumberLike(prev.total), executed);
          const details = Array.isArray(prev.details) ? prev.details : [];
          return { ...prev, executed, total, details: [newRow, ...details] };
        });

        if (expenseItemRef.current) expenseItemRef.current.value = '';
        if (expenseAmountRef.current) expenseAmountRef.current.value = '';
        expenseItemRef.current?.focus();
      };

      const startEditBudgetDetail = (d) => {
        setEditingBudgetId(d.id);
        setBudgetEditDraft({
          date: d.date || todayISO(),
          item: d.item || '',
          amount: String(parseNumberLike(d.amount))
        });
      };

      const cancelEditBudgetDetail = () => {
        setEditingBudgetId(null);
        setBudgetEditDraft({ date: '', item: '', amount: '' });
      };

      const saveEditBudgetDetail = () => {
        const id = editingBudgetId;
        if (!id) return;

        const item = safeText(budgetEditDraft.item).trim();
        const amount = parseNumberLike(budgetEditDraft.amount);
        const date = budgetEditDraft.date || todayISO();
        if (!item || amount <= 0) return;

        setBudget(prev => {
          const details = Array.isArray(prev.details) ? prev.details : [];
          const old = details.find(x => x.id === id);
          const oldAmt = old ? parseNumberLike(old.amount) : 0;

          const nextDetails = details.map(x => x.id === id ? { ...x, item, amount, date } : x);
          const executed = Math.max(0, parseNumberLike(prev.executed) - oldAmt + amount);
          const total = Math.max(parseNumberLike(prev.total), executed);

          return { ...prev, details: nextDetails, executed, total };
        });

        cancelEditBudgetDetail();
      };

      const deleteBudgetDetail = (id) => {
        if (!confirm("í•´ë‹¹ ì§‘í–‰ë‚´ì—­ì„ ì‚­ì œí• ê¹Œìš”?")) return;

        setBudget(prev => {
          const details = Array.isArray(prev.details) ? prev.details : [];
          const target = details.find(x => x.id === id);
          const amt = target ? parseNumberLike(target.amount) : 0;
          const nextDetails = details.filter(x => x.id !== id);

          const executed = Math.max(0, parseNumberLike(prev.executed) - amt);
          const total = Math.max(parseNumberLike(prev.total), executed);

          return { ...prev, details: nextDetails, executed, total };
        });

        if (editingBudgetId === id) cancelEditBudgetDetail();
      };

      // =========================
      // lucide ë Œë”
      // =========================
      useEffect(() => {
        if (window.lucide) window.lucide.createIcons();
      }, [activeTab, municipalIndicators, univIndicators, tasks, budget, loading, isEditingTotal, editingTaskId, editingBudgetId]);

      // =========================
      // ê³µìš© ë Œë”: ë‹¬ì„±ë¥  ê³„ì‚°
      // =========================
      const calcRate = (row) => {
        const target = parseNumberLike(row.target);
        const total = parseNumberLike(row.sem1) + parseNumberLike(row.sem2);
        if (target <= 0) return { total, rate: null };
        const rate = ((total / target) * 100);
        return { total, rate };
      };

      // =========================
      // ë·°: Dashboard
      // =========================
      const DashboardView = () => {
        const completed = tasks.filter(t => t.status === 'Completed').length;
        const inprog = tasks.filter(t => t.status === 'In Progress').length;
        const planned = tasks.filter(t => t.status === 'Planned').length;

        const list = allIndicators
          .filter(r => safeText(r.indicatorName).length) // undefined ë°©ì§€
          .slice(0, 50);

        return (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-slate-500 font-medium">ì´ ì˜ˆì‚° ì§‘í–‰ë¥ </h3>
                  <Icon name="wallet" className="text-blue-600 w-5 h-5" />
                </div>
                <div className="flex items-end gap-2 mb-2">
                  <span className="text-3xl font-bold text-slate-800">{totalBudgetRatio}%</span>
                  <span className="text-sm text-slate-400 mb-1">/ 100%</span>
                </div>
                <div className="relative w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                  <div className="bg-blue-600 h-3 rounded-full" style={{ width: `${Math.min(Number(totalBudgetRatio), 100)}%` }}></div>
                  <div className="absolute inset-0 flex items-center justify-center">
                    <span className="text-[11px] font-bold text-white drop-shadow">{totalBudgetRatio}%</span>
                  </div>
                </div>
                <p className="text-xs text-slate-400 mt-2">
                  ì§‘í–‰ì•¡: {parseNumberLike(budget.executed).toLocaleString()}ì²œì› / ì´ì•¡: {parseNumberLike(budget.total).toLocaleString()}ì²œì›
                </p>
              </div>

              <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-slate-500 font-medium">í‰ê·  ì§€í‘œ ë‹¬ì„±ë¥ </h3>
                  <Icon name="target" className="text-emerald-600 w-5 h-5" />
                </div>
                <div className="flex items-end gap-2 mb-2">
                  <span className="text-3xl font-bold text-slate-800">{averageAchievement}%</span>
                  <span className="text-sm text-slate-400 mb-1">í‰ê· </span>
                </div>
                <div className="w-full bg-slate-100 rounded-full h-2">
                  <div className="bg-emerald-500 h-2 rounded-full" style={{ width: `${Math.min(Number(averageAchievement), 100)}%` }}></div>
                </div>
                <p className="text-xs text-slate-400 mt-2">ëª©í‘œê°€ ìˆëŠ” ì§€í‘œ(ëª©í‘œ&gt;0) ê¸°ì¤€ í‰ê· </p>
              </div>

              <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-slate-500 font-medium">ì„¸ë¶€ê³¼ì œ ì§„í–‰í˜„í™©</h3>
                  <Icon name="calendar" className="text-indigo-600 w-5 h-5" />
                </div>
                <div className="flex flex-col gap-2">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-slate-600">ì™„ë£Œ (Completed)</span>
                    <span className="font-bold text-indigo-600">{completed}ê±´</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-slate-600">ì§„í–‰ì¤‘ (In Progress)</span>
                    <span className="font-bold text-blue-600">{inprog}ê±´</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-slate-600">ì˜ˆì • (Planned)</span>
                    <span className="font-bold text-slate-400">{planned}ê±´</span>
                  </div>
                </div>
              </div>
            </div>

            {/* âœ… ì§€í‘œë³„ ë‹¬ì„± í˜„í™©: ì§€ìì²´+ëŒ€í•™ ëª¨ë‘ í‘œì‹œ */}
            {/* âœ… ì§€í‘œë³„ ë‹¬ì„± í˜„í™©: ì§€ìì²´ + ëŒ€í•™ ì„±ê³¼ì§€í‘œë¥¼ ì„¹ì…˜ìœ¼ë¡œ ë¶„ë¦¬í•´ ëª¨ë‘ í‘œì‹œ */}
<div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
  <div className="flex items-center justify-between mb-4">
    <h3 className="text-lg font-bold text-slate-800">ì§€í‘œë³„ ë‹¬ì„± í˜„í™©</h3>
    <div className="text-xs text-slate-400">ì§€ìì²´ ì„±ê³¼ì§€í‘œ + ëŒ€í•™ ì„±ê³¼ì§€í‘œ(ììœ¨ì„±ê³¼ì§€í‘œ) ëª¨ë‘ í‘œì‹œ</div>
  </div>

  {/* ğŸ” í‘œì‹œ ê°œìˆ˜(ì›í•˜ë©´ ëŠ˜ë¦´ ìˆ˜ ìˆìŒ) */}
  {(() => {
    const municipalList = (Array.isArray(municipalIndicators) ? municipalIndicators : [])
      .filter(r => (r?.indicatorName ?? "").toString().trim().length > 0);

    const univList = (Array.isArray(univIndicators) ? univIndicators : [])
      .filter(r => (r?.indicatorName ?? "").toString().trim().length > 0);

    const renderRows = (rows, prefix) => {
      if (!rows.length) {
        return <div className="text-slate-400 text-sm py-6">í‘œì‹œí•  ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</div>;
      }

      // âœ… ì—¬ê¸°ì„œ slice(0, 50) ìˆ«ìë¥¼ ëŠ˜ë¦¬ë©´ ë” ë§ì´ í‘œì‹œë©ë‹ˆë‹¤.
      return (
        <div className="space-y-4">
          {rows.slice(0, 50).map((row) => {
            const target = Number(row?.target ?? 0) || 0;
            const sem1 = Number(row?.sem1 ?? 0) || 0;
            const sem2 = Number(row?.sem2 ?? 0) || 0;
            const total = sem1 + sem2;

            const rate = target > 0 ? (total / target) * 100 : null;
            const shownRate = rate === null ? 0 : rate;
            const width = Math.min(shownRate, 100);

            const title = `${prefix} Â· ${row.indicatorName}${(row.subItem && row.subItem !== '-') ? ` (${row.subItem})` : ''}`;

            return (
              <div key={row.id}>
                <div className="flex justify-between text-sm mb-1">
                  <span className="font-medium text-slate-700">{title}</span>
                  {target > 0 ? (
                    <span className="text-slate-500">
                      {total.toLocaleString()} / {target.toLocaleString()} ({shownRate.toFixed(1)}%)
                    </span>
                  ) : (
                    <span className="text-slate-400">ëª©í‘œ ì—†ìŒ</span>
                  )}
                </div>

                <div className="w-full bg-slate-100 rounded-full h-2.5">
                  <div
                    className={`h-2.5 rounded-full ${target > 0 && shownRate >= 100 ? 'bg-emerald-500' : 'bg-blue-500'}`}
                    style={{ width: `${target > 0 ? width : 0}%` }}
                  ></div>
                </div>
              </div>
            );
          })}
        </div>
      );
    };

    return (
      <div className="space-y-6">
        {/* ì§€ìì²´ ì„±ê³¼ì§€í‘œ */}
        <div className="rounded-lg border border-slate-100 bg-slate-50 p-4">
          <div className="flex items-center justify-between mb-3">
            <div className="font-bold text-slate-800">ì§€ìì²´ ì„±ê³¼ì§€í‘œ</div>
            <div className="text-xs text-slate-400">í‘œì‹œ {municipalList.length}ê±´</div>
          </div>
          {renderRows(municipalList, "ì§€ìì²´")}
        </div>

        {/* ëŒ€í•™ ì„±ê³¼ì§€í‘œ(ììœ¨ì„±ê³¼ì§€í‘œ) */}
        <div className="rounded-lg border border-slate-100 bg-slate-50 p-4">
          <div className="flex items-center justify-between mb-3">
            <div className="font-bold text-slate-800">ëŒ€í•™ ì„±ê³¼ì§€í‘œ(ììœ¨ì„±ê³¼ì§€í‘œ)</div>
            <div className="text-xs text-slate-400">í‘œì‹œ {univList.length}ê±´</div>
          </div>
          {renderRows(univList, "ëŒ€í•™")}
        </div>
      </div>
    );
  })()}
</div>


              {list.length === 0 ? (
                <div className="text-slate-500 text-sm">í‘œì‹œí•  ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
              ) : (
                <div className="space-y-4">
                  {list.map((row) => {
                    const { total, rate } = calcRate(row);
                    const labelLeft = `${safeText(row.group, "")} Â· ${safeText(row.indicatorName, "")}${safeText(row.subItem, "-") !== "-" ? ` (${row.subItem})` : ""}`;
                    const target = parseNumberLike(row.target);

                    const shownRate = rate === null ? 0 : rate;
                    const width = Math.min(shownRate, 100);

                    return (
                      <div key={row.id}>
                        <div className="flex justify-between text-sm mb-1">
                          <span className="font-medium text-slate-700">{labelLeft}</span>
                          {target > 0 ? (
                            <span className="text-slate-500">{total.toLocaleString()} / {target.toLocaleString()} ({shownRate.toFixed(1)}%)</span>
                          ) : (
                            <span className="text-slate-400">ëª©í‘œ ì—†ìŒ</span>
                          )}
                        </div>
                        <div className="w-full bg-slate-100 rounded-full h-2.5">
                          <div
                            className={`h-2.5 rounded-full ${target > 0 && shownRate >= 100 ? 'bg-emerald-500' : 'bg-blue-500'}`}
                            style={{ width: `${target > 0 ? width : 0}%` }}
                          ></div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        );
      };

      // =========================
      // ë·°: ì •ëŸ‰ì§€í‘œ(ì§€ìì²´/ëŒ€í•™)
      // =========================
      const IndicatorsTable = ({ title, subtitle, rows, group }) => (
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
          <div className="p-6 border-b border-slate-100">
            <h3 className="text-lg font-bold text-slate-800">{title}</h3>
            <p className="text-sm text-slate-500 mt-1">{subtitle}</p>
          </div>

          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left min-w-[980px]">
              <thead className="bg-slate-50 text-slate-600 font-medium">
                <tr>
                  <th className="px-6 py-4">ì§€í‘œëª…</th>
                  <th className="px-4 py-4">êµ¬ì„±í•­ëª©</th>
                  <th className="px-4 py-4 text-center">ë‹¨ìœ„</th>
                  <th className="px-4 py-4 text-right">ê¸°ì¤€ê°’</th>
                  <th className="px-4 py-4 text-right">ëª©í‘œ(A)</th>
                  <th className="px-4 py-4 text-right bg-blue-50">ìƒë°˜ê¸° ì‹¤ì </th>
                  <th className="px-4 py-4 text-right bg-blue-50">í•˜ë°˜ê¸° ì‹¤ì </th>
                  <th className="px-4 py-4 text-right font-bold text-indigo-900 bg-indigo-50">í•©ê³„(B)</th>
                  <th className="px-4 py-4 text-right font-bold text-indigo-900 bg-indigo-50">ë‹¬ì„±ë¥ (%)</th>
                </tr>
              </thead>

              <tbody className="divide-y divide-slate-100">
                {rows.length === 0 ? (
                  <tr>
                    <td className="px-6 py-8 text-center text-slate-400" colSpan="9">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                  </tr>
                ) : rows.map((r) => {
                  const { total, rate } = calcRate(r);
                  const target = parseNumberLike(r.target);
                  return (
                    <tr key={r.id} className="hover:bg-slate-50">
                      <td className="px-6 py-4 font-medium text-slate-800">{safeText(r.indicatorName, "")}</td>
                      <td className="px-4 py-4 text-slate-600">{safeText(r.subItem, "-")}</td>
                      <td className="px-4 py-4 text-center text-slate-500">{safeText(r.unit, "")}</td>
                      <td className="px-4 py-4 text-right text-slate-600">{parseNumberLike(r.baseline).toLocaleString()}</td>
                      <td className="px-4 py-4 text-right text-slate-600">{target.toLocaleString()}</td>

                      <td className="px-4 py-4 text-right bg-blue-50/30">
                        <input
                          type="text"
                          inputMode="numeric"
                          className="w-24 text-right p-1 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none"
                          value={r.sem1}
                          onChange={(e) => updateIndicator(group, r.id, 'sem1', e.target.value)}
                        />
                      </td>

                      <td className="px-4 py-4 text-right bg-blue-50/30">
                        <input
                          type="text"
                          inputMode="numeric"
                          className="w-24 text-right p-1 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none"
                          value={r.sem2}
                          onChange={(e) => updateIndicator(group, r.id, 'sem2', e.target.value)}
                        />
                      </td>

                      <td className="px-4 py-4 text-right font-bold text-indigo-700 bg-indigo-50/30">{total.toLocaleString()}</td>
                      <td className="px-4 py-4 text-right font-bold bg-indigo-50/30">
                        {target > 0 ? (
                          <span className={`${(rate ?? 0) >= 100 ? 'text-emerald-600' : 'text-orange-500'}`}>{(rate ?? 0).toFixed(1)}%</span>
                        ) : (
                          <span className="text-slate-400">-</span>
                        )}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );

      const PerformanceView = () => (
        <div className="space-y-6">
          <div className="bg-white rounded-xl shadow-sm border border-slate-200">
            <div className="p-6 border-b border-slate-100 flex justify-between items-center">
              <div>
                <h2 className="text-xl font-bold text-slate-800">ì •ëŸ‰ì§€í‘œ ê´€ë¦¬</h2>
                <p className="text-sm text-slate-500">ì§€ìì²´ ì„±ê³¼ì§€í‘œ / ëŒ€í•™ ììœ¨ì„±ê³¼ì§€í‘œ ì‹¤ì  ì…ë ¥ ë° ê´€ë¦¬</p>
              </div>
              <div className="flex items-center gap-3">
                {saveMsg && <span className="text-sm text-slate-500">{saveMsg}</span>}
                <button
                  onClick={saveToFirebase}
                  className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                  <Icon name="save" className="w-4 h-4" /> ì €ì¥í•˜ê¸°
                </button>
              </div>
            </div>
          </div>

          <IndicatorsTable
            title="[ì§€ìì²´] ì„±ê³¼ëª©í‘œ ë‹¬ì„±ìœ¨"
            subtitle="1ì°¨ë…„ë„ ì„±ê³¼ì§€í‘œ ë° ì‹¤ì "
            rows={Array.isArray(municipalIndicators) ? municipalIndicators : []}
            group="ì§€ìì²´"
          />

          <IndicatorsTable
            title="[ëŒ€í•™] ììœ¨ì„±ê³¼ì§€í‘œ"
            subtitle="1ì°¨ë…„ë„ ììœ¨ì„±ê³¼ì§€í‘œ ë° ì‹¤ì (í˜„ì¬)"
            rows={Array.isArray(univIndicators) ? univIndicators : []}
            group="ëŒ€í•™"
          />
        </div>
      );

      // =========================
      // ë·°: ì„¸ë¶€ê³¼ì œ(ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ)
      // =========================
      const TasksView = () => (
        <div className="space-y-6">
          <div className="bg-white rounded-xl shadow-sm border border-slate-200">
            <div className="p-6 border-b border-slate-100 flex items-center justify-between">
              <div>
                <h2 className="text-xl font-bold text-slate-800">ì„¸ë¶€ì¶”ì§„ê³¼ì œ ê´€ë¦¬</h2>
                <p className="text-sm text-slate-500">ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ë° ì§„í–‰ìƒíƒœ ëª¨ë‹ˆí„°ë§</p>
              </div>
              <div className="flex items-center gap-3">
                {saveMsg && <span className="text-sm text-slate-500">{saveMsg}</span>}
                <button
                  onClick={saveToFirebase}
                  className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                  <Icon name="save" className="w-4 h-4" /> ì €ì¥í•˜ê¸°
                </button>
              </div>
            </div>

            {/* ì¶”ê°€ í¼(ì—°ì†ì…ë ¥ ì•ˆì •: uncontrolled) */}
            <div className="p-6 border-b border-slate-100 bg-slate-50">
              <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                <input
                  ref={taskCategoryRef}
                  type="text"
                  placeholder="ë¶„ë¥˜(ì˜ˆ: ì·¨ì—…ì§€ì›ì„¼í„°)"
                  className="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm bg-white"
                  autoComplete="off"
                  spellCheck={false}
                />
                <input
                  ref={taskNameRef}
                  type="text"
                  placeholder="ê³¼ì œëª…"
                  className="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm bg-white md:col-span-2"
                  autoComplete="off"
                  spellCheck={false}
                />
                <input
                  ref={taskScheduleRef}
                  type="text"
                  placeholder="ì¼ì •(ì˜ˆ: 2025.06~2026.02)"
                  className="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm bg-white"
                  autoComplete="off"
                  spellCheck={false}
                />
              </div>

              <div className="mt-3 flex gap-3">
                <input
                  ref={taskNoteRef}
                  type="text"
                  placeholder="ë¹„ê³ (ì„ íƒ)"
                  className="flex-1 p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm bg-white"
                  autoComplete="off"
                  spellCheck={false}
                  onKeyDown={(e) => { if (e.key === "Enter") addTask(); }}
                />
                <button
                  onClick={addTask}
                  className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 text-sm font-medium"
                >
                  + ì¶”ê°€
                </button>
              </div>
            </div>

            {/* ëª©ë¡ */}
            <div className="p-6 grid gap-4">
              {(Array.isArray(tasks) ? tasks : []).map((task) => {
                const isEditing = editingTaskId === task.id;

                return (
                  <div key={task.id} className="p-4 bg-slate-50 rounded-lg border border-slate-100 hover:border-blue-200">
                    <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                      {/* ì¢Œì¸¡ ì •ë³´ */}
                      <div className="flex-1">
                        {!isEditing ? (
                          <>
                            <div className="flex items-center gap-2 mb-1">
                              <span className="px-2 py-0.5 text-xs font-bold text-slate-600 bg-slate-200 rounded">{safeText(task.category, "")}</span>
                              <span className="text-xs text-slate-400">{safeText(task.schedule, "")}</span>
                            </div>
                            <h3 className="text-base font-semibold text-slate-800">{safeText(task.name, "")}</h3>
                            {safeText(task.note, "").length > 0 && (
                              <p className="text-sm text-slate-500 mt-1">ë¹„ê³ : {task.note}</p>
                            )}
                          </>
                        ) : (
                          <div className="space-y-2">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                              <input
                                type="text"
                                className="p-2 border border-slate-300 rounded-lg text-sm bg-white"
                                value={taskEditDraft.category}
                                onChange={(e) => setTaskEditDraft(prev => ({ ...prev, category: e.target.value }))}
                              />
                              <input
                                type="text"
                                className="p-2 border border-slate-300 rounded-lg text-sm bg-white md:col-span-2"
                                value={taskEditDraft.name}
                                onChange={(e) => setTaskEditDraft(prev => ({ ...prev, name: e.target.value }))}
                              />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                              <input
                                type="text"
                                className="p-2 border border-slate-300 rounded-lg text-sm bg-white"
                                value={taskEditDraft.schedule}
                                onChange={(e) => setTaskEditDraft(prev => ({ ...prev, schedule: e.target.value }))}
                              />
                              <input
                                type="text"
                                className="p-2 border border-slate-300 rounded-lg text-sm bg-white md:col-span-2"
                                value={taskEditDraft.note}
                                onChange={(e) => setTaskEditDraft(prev => ({ ...prev, note: e.target.value }))}
                                onKeyDown={(e) => { if (e.key === "Enter") saveEditTask(); }}
                              />
                            </div>
                          </div>
                        )}
                      </div>

                      {/* ìš°ì¸¡ ì»¨íŠ¸ë¡¤ */}
                      <div className="flex flex-col sm:flex-row items-start sm:items-center gap-2">
                        {/* ìƒíƒœ */}
                        <div className="flex items-center gap-2">
                          {['Planned', 'In Progress', 'Completed'].map((status) => (
                            <button
                              key={status}
                              onClick={() => setTaskStatus(task.id, status)}
                              className={`px-3 py-1.5 text-xs font-medium rounded-full border ${
                                task.status === status
                                  ? status === 'Completed' ? 'bg-emerald-100 text-emerald-700 border-emerald-200'
                                  : status === 'In Progress' ? 'bg-blue-100 text-blue-700 border-blue-200'
                                  : 'bg-slate-200 text-slate-700 border-slate-300'
                                  : 'bg-white text-slate-400 border-slate-200 hover:bg-slate-50'
                              }`}
                            >
                              {status === 'Planned' ? 'ì˜ˆì •' : status === 'In Progress' ? 'ì§„í–‰ì¤‘' : 'ì™„ë£Œ'}
                            </button>
                          ))}
                        </div>

                        {/* ìˆ˜ì •/ì‚­ì œ */}
                        {!isEditing ? (
                          <div className="flex items-center gap-2">
                            <button
                              onClick={() => startEditTask(task)}
                              className="px-3 py-1.5 text-xs rounded-lg bg-blue-600 text-white hover:bg-blue-700"
                            >
                              ìˆ˜ì •
                            </button>
                            <button
                              onClick={() => deleteTask(task.id)}
                              className="px-3 py-1.5 text-xs rounded-lg bg-rose-600 text-white hover:bg-rose-700"
                            >
                              ì‚­ì œ
                            </button>
                          </div>
                        ) : (
                          <div className="flex items-center gap-2">
                            <button
                              onClick={saveEditTask}
                              className="px-3 py-1.5 text-xs rounded-lg bg-emerald-600 text-white hover:bg-emerald-700"
                            >
                              ì €ì¥
                            </button>
                            <button
                              onClick={cancelEditTask}
                              className="px-3 py-1.5 text-xs rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300"
                            >
                              ì·¨ì†Œ
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}

              {(!Array.isArray(tasks) || tasks.length === 0) && (
                <div className="text-slate-400 text-sm text-center py-10">ë“±ë¡ëœ ì„¸ë¶€ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
              )}
            </div>
          </div>
        </div>
      );

      // =========================
      // ë·°: ì˜ˆì‚°(ìš”ì•½ ì¹´ë“œ ì—†ìŒ)
      // =========================
      const BudgetView = () => {
        const remaining = Math.max(0, parseNumberLike(budget.total) - parseNumberLike(budget.executed));
        const ratio = totalBudgetRatio;

        return (
          <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                <div>
                  <h2 className="text-xl font-bold text-slate-800">ì˜ˆì‚° ì§‘í–‰ í˜„í™©</h2>
                  <p className="text-sm text-slate-500">ì´ì˜ˆì‚°/ì§‘í–‰ì•¡/ì”ì•¡ ë° ì§‘í–‰ë‚´ì—­ ë“±ë¡Â·ìˆ˜ì •Â·ì‚­ì œ</p>
                </div>
                <div className="flex items-center gap-3">
                  {saveMsg && <span className="text-sm text-slate-500">{saveMsg}</span>}
                  <button
                    onClick={saveToFirebase}
                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    <Icon name="save" className="w-4 h-4" /> ì €ì¥í•˜ê¸°
                  </button>
                </div>
              </div>

              <div className="p-6">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                  {/* ì´ì˜ˆì‚° */}
                  <div className="p-4 bg-slate-50 rounded-lg text-center">
                    <div className="text-sm text-slate-500 mb-2 flex items-center justify-center gap-2">
                      <span>ì´ ì˜ˆì‚°</span>
                      {!isEditingTotal ? (
                        <button
                          onClick={startEditTotal}
                          className="inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs bg-white border border-slate-200 text-slate-600 hover:bg-slate-100"
                          title="ì´ ì˜ˆì‚° ìˆ˜ì •"
                        >
                          <Icon name="pencil" className="w-3 h-3" /> ìˆ˜ì •
                        </button>
                      ) : null}
                    </div>

                    {!isEditingTotal ? (
                      <div className="text-lg font-bold text-slate-800">{parseNumberLike(budget.total).toLocaleString()} ì²œì›</div>
                    ) : (
                      <div className="space-y-2">
                        <input
                          type="text"
                          inputMode="numeric"
                          className="w-full p-2 border border-slate-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500 focus:outline-none"
                          value={totalDraft}
                          onChange={(e) => setTotalDraft(e.target.value)}
                          onKeyDown={(e) => { if (e.key === 'Enter') saveEditTotal(); }}
                        />
                        <div className="flex justify-center gap-2">
                          <button
                            onClick={saveEditTotal}
                            className="px-3 py-1.5 text-xs rounded-lg bg-emerald-600 text-white hover:bg-emerald-700"
                          >ì €ì¥</button>
                          <button
                            onClick={cancelEditTotal}
                            className="px-3 py-1.5 text-xs rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300"
                          >ì·¨ì†Œ</button>
                        </div>
                        <div className="text-[11px] text-slate-400">
                          â€» ì§‘í–‰ì•¡({parseNumberLike(budget.executed).toLocaleString()})ë³´ë‹¤ ì‘ê²Œ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì§‘í–‰ì•¡ìœ¼ë¡œ ë³´ì •ë©ë‹ˆë‹¤.
                        </div>
                      </div>
                    )}
                  </div>

                  {/* ì§‘í–‰ì•¡ */}
                  <div className="p-4 bg-blue-50 rounded-lg text-center border border-blue-100">
                    <div className="text-sm text-blue-600 mb-1">ì§‘í–‰ì•¡</div>
                    <div className="text-lg font-bold text-blue-700">{parseNumberLike(budget.executed).toLocaleString()} ì²œì›</div>
                  </div>

                  {/* ì”ì•¡ */}
                  <div className="p-4 bg-emerald-50 rounded-lg text-center border border-emerald-100">
                    <div className="text-sm text-emerald-600 mb-1">ì”ì•¡</div>
                    <div className="text-lg font-bold text-emerald-700">{remaining.toLocaleString()} ì²œì›</div>
                  </div>
                </div>

                {/* ì§‘í–‰ ë“±ë¡ */}
                <h3 className="text-sm font-bold text-slate-700 mb-3">ì§‘í–‰ ë‚´ì—­ ë“±ë¡</h3>
                <div className="flex flex-col md:flex-row gap-2 mb-4">
                  <input
                    ref={expenseItemRef}
                    type="text"
                    placeholder="í•­ëª©ëª… (ì˜ˆ: ìº¡ìŠ¤í†¤ ì¬ë£Œë¹„)"
                    className="flex-1 p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm"
                    autoComplete="off"
                    spellCheck={false}
                  />
                  <input
                    ref={expenseAmountRef}
                    type="text"
                    inputMode="numeric"
                    placeholder="ê¸ˆì•¡ (ì²œì›)"
                    className="md:w-40 p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm"
                    autoComplete="off"
                    spellCheck={false}
                    onKeyDown={(e) => { if (e.key === 'Enter') addExpense(); }}
                  />
                  <button
                    onClick={addExpense}
                    className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 text-sm font-medium"
                  >
                    ë“±ë¡
                  </button>
                </div>

                {/* ì§‘í–‰ë¥  ë°” */}
                <div className="mt-2">
                  <div className="flex items-center justify-between mb-1">
                    <div className="text-xs text-slate-500">í˜„ì¬ ì§‘í–‰ë¥ </div>
                    <div className="text-xs font-bold text-slate-700">{ratio}%</div>
                  </div>
                  <div className="relative w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                    <div
                      className="bg-blue-600 h-3 rounded-full"
                      style={{ width: `${Math.min(Number(ratio), 100)}%` }}
                    ></div>
                    <div className="absolute inset-0 flex items-center justify-center">
                      <span className="text-[11px] font-bold text-white drop-shadow">{ratio}%</span>
                    </div>
                  </div>
                </div>

                {/* ì§‘í–‰ ë‚´ì—­ */}
                <div className="mt-6 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                  <div className="p-4 border-b border-slate-100 bg-slate-50">
                    <h3 className="font-semibold text-slate-700">ìµœê·¼ ì§‘í–‰ ë‚´ì—­ (ìˆ˜ì •/ì‚­ì œ)</h3>
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full text-sm min-w-[980px]">
                      <thead className="bg-white text-slate-500 border-b border-slate-100">
                        <tr>
                          <th className="px-6 py-3 text-left w-[140px]">ì¼ì</th>
                          <th className="px-6 py-3 text-left">í•­ëª©</th>
                          <th className="px-6 py-3 text-right w-[160px]">ê¸ˆì•¡ (ì²œì›)</th>
                          <th className="px-6 py-3 text-center w-[90px]">êµ¬ë¶„</th>
                          <th className="px-6 py-3 text-center w-[220px]">ê´€ë¦¬</th>
                        </tr>
                      </thead>

                      <tbody className="divide-y divide-slate-100">
                        {(Array.isArray(budget.details) ? budget.details : []).map((d) => {
                          const isEditing = editingBudgetId === d.id;
                          return (
                            <tr key={d.id} className={isEditing ? "bg-yellow-50/60" : ""}>
                              <td className="px-6 py-3 text-slate-600">
                                {isEditing ? (
                                  <input
                                    type="date"
                                    className="p-1 border border-slate-300 rounded"
                                    value={budgetEditDraft.date}
                                    onChange={(e) => setBudgetEditDraft(prev => ({ ...prev, date: e.target.value }))}
                                  />
                                ) : (d.date || '')}
                              </td>

                              <td className="px-6 py-3 text-slate-800 font-medium">
                                {isEditing ? (
                                  <input
                                    type="text"
                                    className="w-full p-1 border border-slate-300 rounded"
                                    value={budgetEditDraft.item}
                                    onChange={(e) => setBudgetEditDraft(prev => ({ ...prev, item: e.target.value }))}
                                  />
                                ) : (d.item || '')}
                              </td>

                              <td className="px-6 py-3 text-right text-slate-600">
                                {isEditing ? (
                                  <input
                                    type="text"
                                    inputMode="numeric"
                                    className="w-28 text-right p-1 border border-slate-300 rounded"
                                    value={budgetEditDraft.amount}
                                    onChange={(e) => setBudgetEditDraft(prev => ({ ...prev, amount: e.target.value }))}
                                    onKeyDown={(e) => { if (e.key === 'Enter') saveEditBudgetDetail(); }}
                                  />
                                ) : parseNumberLike(d.amount).toLocaleString()}
                              </td>

                              <td className="px-6 py-3 text-center">
                                <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">
                                  {d.type || 'ì§‘í–‰'}
                                </span>
                              </td>

                              <td className="px-6 py-3 text-center">
                                {isEditing ? (
                                  <div className="flex justify-center gap-2">
                                    <button
                                      onClick={saveEditBudgetDetail}
                                      className="px-3 py-1.5 text-xs rounded-lg bg-emerald-600 text-white hover:bg-emerald-700"
                                    >ì €ì¥</button>
                                    <button
                                      onClick={cancelEditBudgetDetail}
                                      className="px-3 py-1.5 text-xs rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300"
                                    >ì·¨ì†Œ</button>
                                  </div>
                                ) : (
                                  <div className="flex justify-center gap-2">
                                    <button
                                      onClick={() => startEditBudgetDetail(d)}
                                      className="px-3 py-1.5 text-xs rounded-lg bg-blue-600 text-white hover:bg-blue-700"
                                    >ìˆ˜ì •</button>
                                    <button
                                      onClick={() => deleteBudgetDetail(d.id)}
                                      className="px-3 py-1.5 text-xs rounded-lg bg-rose-600 text-white hover:bg-rose-700"
                                    >ì‚­ì œ</button>
                                  </div>
                                )}
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>

                  <div className="p-3 text-xs text-slate-400 border-t border-slate-100">
                    â€» í™”ë©´ì´ ì¢ìœ¼ë©´ ê°€ë¡œ ìŠ¤í¬ë¡¤ë¡œ â€œê´€ë¦¬(ìˆ˜ì •/ì‚­ì œ)â€ ë²„íŠ¼ì´ í‘œì‹œë©ë‹ˆë‹¤.
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // =========================
      // ë„¤ë¹„
      // =========================
      const navItems = [
        { id: 'dashboard', label: 'ëŒ€ì‹œë³´ë“œ', icon: 'layout-dashboard' },
        { id: 'performance', label: 'ì •ëŸ‰ì§€í‘œ', icon: 'target' },
        { id: 'tasks', label: 'ì„¸ë¶€ê³¼ì œ', icon: 'calendar' },
        { id: 'budget', label: 'ì˜ˆì‚°ê´€ë¦¬', icon: 'wallet' },
      ];

      return (
        <div className="min-h-screen bg-slate-50 text-slate-900">
          <header className="bg-white border-b border-slate-200 sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-3 py-3">
                <div className="flex items-center gap-2">
                  <div className="bg-blue-600 text-white p-1.5 rounded-lg">
                    <Icon name="trending-up" className="w-5 h-5" />
                  </div>
                  <h1 className="text-lg font-bold text-slate-800">[2-1] ì–¼ë¦¬ë²„ë“œ ì·¨ì—…ì§€ì› ì‚¬ì—…ì‹¤ì ê´€ë¦¬</h1>
                </div>

                <nav className="flex flex-wrap gap-1">
                  {navItems.map((item) => (
                    <button
                      key={item.id}
                      onClick={() => setActiveTab(item.id)}
                      className={`flex items-center px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        activeTab === item.id
                          ? 'bg-slate-100 text-blue-700'
                          : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'
                      }`}
                    >
                      <Icon name={item.icon} className="w-4 h-4 mr-2" />
                      {item.label}
                    </button>
                  ))}
                </nav>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {loading ? (
              <div className="bg-white p-6 rounded-xl border border-slate-200 text-slate-600">
                Firebaseì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
              </div>
            ) : (
              <>
                {activeTab === 'dashboard' && <DashboardView />}
                {activeTab === 'performance' && <PerformanceView />}
                {activeTab === 'tasks' && <TasksView />}
                {activeTab === 'budget' && <BudgetView />}
              </>
            )}
          </main>
        </div>
      );
    }

    // Mount
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<EarlyBirdManager />);
  </script>
</body>
</html>

