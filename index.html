<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>[2-1] 얼리버드 취업지원 사업실적관리</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <style>
    body { font-family: "Malgun Gothic", "Noto Sans KR", sans-serif; }
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    
    /* 테이블 가독성을 위한 스타일 */
    .table-header { background-color: #f8fafc; color: #475569; font-weight: 600; }
    .input-cell { background-color: #eff6ff; } /* 입력칸 배경색 (연한 파랑) */
    .result-cell { background-color: #eef2ff; color: #312e81; font-weight: 700; } /* 결과칸 배경색 (연한 인디고) */
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    // ==========================================
    // 1. 설정 및 유틸
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyDp5-SjGHdLRQ7feRoS-RdKsJI4QFUJKQ0",
      authDomain: "perf-indicator.firebaseapp.com",
      databaseURL: "https://perf-indicator-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "perf-indicator",
      storageBucket: "perf-indicator.firebasestorage.app",
      messagingSenderId: "425708194902",
      appId: "1:425708194902:web:1bd90a680999b8791b3ff7"
    };

    try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } 
    catch (e) { console.error("Firebase init error:", e); }

    const db = firebase.database();
    const DB_PATH = "earlyBirdManager/v2";

    const parseNumberLike = (v) => {
      if (v === null || v === undefined || v === "") return 0;
      const s = String(v).replace(/[^\d.-]/g, '');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };
    const safeText = (v) => (v ?? '').toString();
    const newId = () => Date.now() + Math.floor(Math.random() * 1000);
    const todayISO = () => new Date().toISOString().split('T')[0];
    const Icon = ({ name, className }) => <i data-lucide={name} className={className}></i>;

    // ==========================================
    // 2. 초기 데이터 (상위 3줄 삭제 반영)
    // ==========================================
    const INITIAL_MUNICIPAL = [
      // 상위 3줄(합계, 소계, 기업연계) 삭제됨
      { id: 104, group: "지자체", indicatorName: "캡스톤디자인 및 현장실습 이수학생 수", subItem: "일반", unit: "명", baseline: 498, target: 523, sem1: 328, sem2: 0 },
      { id: 105, group: "지자체", indicatorName: "캡스톤디자인 및 현장실습 이수학생 수", subItem: "소계(현장실습)", unit: "명", baseline: 238, target: 250, sem1: 345, sem2: 254 },
      { id: 106, group: "지자체", indicatorName: "캡스톤디자인 및 현장실습 이수학생 수", subItem: "표준형", unit: "명", baseline: 62, target: 65, sem1: 55, sem2: 28 },
      { id: 107, group: "지자체", indicatorName: "캡스톤디자인 및 현장실습 이수학생 수", subItem: "기타(자율 및 의무형)", unit: "명", baseline: 176, target: 185, sem1: 290, sem2: 226 },

      // 2. 대전형 360인재 지역 정주 취업자 수 (합계만 유지)
      { id: 201, group: "지자체", indicatorName: "대전형 360°인재 지역 정주 취업자 수", subItem: "합계", unit: "명", baseline: 1081, target: 1135, sem1: 0, sem2: 0 },
    ];

    const INITIAL_UNIV = [
      { id: 301, group: "대학", indicatorName: "캡스톤디자인 및 현장실습 연계 비교과 이수학생 수", subItem: "-", unit: "명", baseline: 256, target: 270, sem1: 177, sem2: 0 },
      { id: 302, group: "대학", indicatorName: "표준현장실습 학기제 이수학생 취업률", subItem: "-", unit: "%", baseline: 36.8, target: 40, sem1: 0, sem2: 0 },
    ];

    const INITIAL_TASKS = [
      { id: 1, category: '취업지원센터', name: 'RISE 기반 AI 잡매칭 플랫폼 개발', schedule: '2025-06-01', status: 'In Progress', note: '업체선정완료 및 개발 중' },
      { id: 2, category: '취업지원센터', name: 'RISE 기반 4i ICC 현장 중심 취업지원', schedule: '2025-06-15', status: 'In Progress', note: '단대별 6개과목 교육진행' },
    ];

    const INITIAL_BUDGET = {
      total: 665000,
      executed: 0,
      details: []
    };

    // ==========================================
    // 3. 하위 컴포넌트들
    // ==========================================

    // [지표 테이블]
    const IndicatorsTable = ({ title, rows, group, onUpdate }) => {
      return (
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
          <div className="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
            <h3 className="font-bold text-slate-800 flex items-center gap-2">
              <Icon name="table-2" className="w-5 h-5 text-blue-600" /> {title}
            </h3>
            <span className="text-xs text-slate-400">※ 값을 입력하면 합계와 달성률이 실시간으로 변경됩니다.</span>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left min-w-[1100px]">
              <thead className="table-header border-b border-slate-200">
                <tr>
                  <th className="px-4 py-3 w-[25%]">지표명</th>
                  <th className="px-4 py-3 w-[15%]">세부항목</th>
                  <th className="px-4 py-3 text-center w-[5%]">단위</th>
                  <th className="px-4 py-3 text-right w-[8%]">기준값</th>
                  <th className="px-4 py-3 text-right w-[8%]">목표(A)</th>
                  <th className="px-4 py-3 text-right w-[10%] input-cell">상반기</th>
                  <th className="px-4 py-3 text-right w-[10%] input-cell">하반기</th>
                  <th className="px-4 py-3 text-right w-[10%] result-cell">합계(B)</th>
                  <th className="px-4 py-3 text-right w-[9%] result-cell">달성률</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {rows.map((row) => {
                  const target = parseNumberLike(row.target);
                  const s1 = row.sem1 === 0 ? 0 : (row.sem1 || "");
                  const s2 = row.sem2 === 0 ? 0 : (row.sem2 || "");
                  
                  const total = parseNumberLike(s1) + parseNumberLike(s2);
                  let rate = target > 0 ? (total / target) * 100 : 0;
                  
                  // 소계, 합계 볼드체 처리
                  const isSubtotal = row.subItem && (row.subItem.includes("합계") || row.subItem.includes("소계"));
                  const rowClass = isSubtotal ? "bg-slate-50 font-bold" : "hover:bg-slate-50";

                  let rateColor = "text-slate-600";
                  if(target > 0) {
                      if(rate >= 100) rateColor = "text-emerald-600 font-bold";
                      else if(rate >= 80) rateColor = "text-orange-500 font-bold";
                      else rateColor = "text-red-500 font-bold";
                  }

                  return (
                    <tr key={row.id} className={`${rowClass} transition-colors`}>
                      <td className="px-4 py-3 text-slate-800">{row.indicatorName}</td>
                      <td className="px-4 py-3 text-slate-500">{row.subItem}</td>
                      <td className="px-4 py-3 text-center text-slate-500">{row.unit}</td>
                      <td className="px-4 py-3 text-right text-slate-600">{parseNumberLike(row.baseline).toLocaleString()}</td>
                      <td className="px-4 py-3 text-right text-slate-800 font-medium">{target.toLocaleString()}</td>
                      
                      <td className="px-4 py-2 text-right input-cell border-l border-white">
                        <input 
                          type="number" 
                          className={`w-full text-right p-1.5 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white shadow-sm ${isSubtotal ? 'font-bold' : ''}`}
                          value={s1} 
                          placeholder="0"
                          onChange={(e) => onUpdate(group, row.id, 'sem1', e.target.value)}
                        />
                      </td>
                      
                      <td className="px-4 py-2 text-right input-cell border-l border-white">
                        <input 
                          type="number" 
                          className={`w-full text-right p-1.5 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white shadow-sm ${isSubtotal ? 'font-bold' : ''}`}
                          value={s2} 
                          placeholder="0"
                          onChange={(e) => onUpdate(group, row.id, 'sem2', e.target.value)}
                        />
                      </td>
                      
                      <td className="px-4 py-3 text-right result-cell border-l border-slate-200">{total.toLocaleString()}</td>
                      <td className={`px-4 py-3 text-right result-cell border-l border-slate-200 ${rateColor}`}>{target > 0 ? `${rate.toFixed(1)}%` : "-"}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    // [세부과제 뷰]
    const TasksView = ({ tasks, setTasks, onSave, saveMsg }) => {
      const categoryRef = useRef();
      const nameRef = useRef();
      const scheduleRef = useRef();
      const noteRef = useRef();
      const [editingId, setEditingId] = useState(null);
      const [draft, setDraft] = useState({});

      const addTask = () => {
        const category = categoryRef.current?.value.trim();
        const name = nameRef.current?.value.trim();
        if(!category || !name) return;
        const schedule = scheduleRef.current?.value || todayISO();
        const newTask = {
           id: newId(), category, name, 
           schedule, 
           note: noteRef.current?.value || '', status: 'Planned' 
        };
        setTasks(prev => [newTask, ...prev]);
        categoryRef.current.value = ''; nameRef.current.value = ''; 
        scheduleRef.current.value = todayISO();
        noteRef.current.value = '';
      };

      const startEdit = (t) => { setEditingId(t.id); setDraft({...t}); };
      const saveEdit = () => {
        setTasks(prev => prev.map(t => t.id === editingId ? draft : t));
        setEditingId(null);
      };
      const removeTask = (id) => { if(confirm('삭제합니까?')) setTasks(prev => prev.filter(t => t.id !== id)); };

      return (
        <div className="space-y-6">
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex justify-between items-center">
             <div><h2 className="text-xl font-bold text-slate-800">세부추진과제 관리</h2><p className="text-sm text-slate-500">진행상태 및 과제 관리</p></div>
             <div className="flex gap-3 items-center">{saveMsg && <span className="text-sm text-blue-600">{saveMsg}</span>}
             <button onClick={onSave} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold flex gap-2"><Icon name="save" className="w-4 h-4"/> 저장하기</button></div>
          </div>
          
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
             <div className="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4 bg-slate-50 p-4 rounded-lg">
                <input ref={categoryRef} className="p-2 border rounded" placeholder="분류 (예: 취업지원)" />
                <input ref={nameRef} className="p-2 border rounded md:col-span-2" placeholder="과제명" />
                <input ref={scheduleRef} type="date" className="p-2 border rounded text-slate-600" defaultValue={todayISO()} />
                <input ref={noteRef} className="p-2 border rounded md:col-span-4" placeholder="비고" />
                <button onClick={addTask} className="bg-slate-900 text-white rounded font-bold hover:bg-slate-800 p-2 md:col-span-4">+ 과제 추가</button>
             </div>
             <div className="space-y-3">
                {tasks.map(t => {
                   const isEdit = editingId === t.id;
                   return (
                     <div key={t.id} className="p-4 bg-white border border-slate-200 rounded-lg flex flex-col md:flex-row gap-4 items-start md:items-center justify-between hover:border-blue-300 transition-colors">
                        {isEdit ? (
                           <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-2 w-full">
                              <input value={draft.category} onChange={e=>setDraft({...draft, category:e.target.value})} className="p-1 border rounded" placeholder="분류"/>
                              <input value={draft.name} onChange={e=>setDraft({...draft, name:e.target.value})} className="p-1 border rounded" placeholder="과제명"/>
                              <input type="date" value={draft.schedule} onChange={e=>setDraft({...draft, schedule:e.target.value})} className="p-1 border rounded"/>
                              <input value={draft.note} onChange={e=>setDraft({...draft, note:e.target.value})} className="p-1 border rounded" placeholder="비고"/>
                           </div>
                        ) : (
                           <div className="flex-1">
                              <div className="flex gap-2 mb-1"><span className="bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded font-bold border border-slate-200">{t.category}</span>
                              <span className="text-xs text-slate-400 flex items-center gap-1"><Icon name="calendar" className="w-3 h-3"/> {t.schedule}</span></div>
                              <div className="font-bold text-slate-800">{t.name}</div>
                              {t.note && <div className="text-sm text-slate-500 mt-1">비고: {t.note}</div>}
                           </div>
                        )}
                        <div className="flex gap-2 items-center">
                           {!isEdit && ['Planned','In Progress','Completed'].map(st => (
                              <button key={st} onClick={()=>setTasks(prev=>prev.map(x=>x.id===t.id?{...x, status:st}:x))} 
                                className={`px-2 py-1 text-xs rounded border transition-colors ${t.status===st ? (st==='Completed'?'bg-emerald-100 border-emerald-300 text-emerald-700':'bg-blue-100 border-blue-300 text-blue-700') : 'bg-white text-slate-400 hover:bg-slate-50'}`}>
                                {st==='Planned'?'예정':st==='In Progress'?'진행':'완료'}
                              </button>
                           ))}
                           {isEdit ? (
                              <><button onClick={saveEdit} className="px-3 py-1 bg-emerald-600 text-white rounded text-xs hover:bg-emerald-700">저장</button>
                                <button onClick={()=>setEditingId(null)} className="px-3 py-1 bg-slate-300 text-slate-700 rounded text-xs hover:bg-slate-400">취소</button></>
                           ) : (
                              <><button onClick={()=>startEdit(t)} className="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">수정</button>
                                <button onClick={()=>removeTask(t.id)} className="px-3 py-1 bg-rose-600 text-white rounded text-xs hover:bg-rose-700">삭제</button></>
                           )}
                        </div>
                     </div>
                   );
                })}
             </div>
          </div>
        </div>
      );
    };

    // [예산 뷰]
    const BudgetView = ({ budget, setBudget, onSave, saveMsg }) => {
      const dateRef = useRef();
      const itemRef = useRef();
      const amountRef = useRef();
      const [isEditingTotal, setIsEditingTotal] = useState(false);
      const [totalDraft, setTotalDraft] = useState("");
      const [editingDetailId, setEditingDetailId] = useState(null);
      const [detailDraft, setDetailDraft] = useState({});

      const remaining = Math.max(0, parseNumberLike(budget.total) - parseNumberLike(budget.executed));
      const ratio = parseNumberLike(budget.total) > 0 
        ? ((parseNumberLike(budget.executed) / parseNumberLike(budget.total)) * 100).toFixed(1) 
        : 0;

      const addDetail = () => {
         const date = dateRef.current?.value || todayISO();
         const item = itemRef.current?.value.trim();
         const amount = parseNumberLike(amountRef.current?.value);
         if(!item || amount <= 0) return;
         
         const newDetail = { id: newId(), date, item, amount, type: '집행' };
         const newDetails = [newDetail, ...(budget.details || [])];
         const newExecuted = parseNumberLike(budget.executed) + amount;
         
         setBudget({ ...budget, details: newDetails, executed: newExecuted });
         itemRef.current.value = ''; amountRef.current.value = '';
      };

      const saveTotal = () => {
         const val = parseNumberLike(totalDraft);
         setBudget({...budget, total: val}); 
         setIsEditingTotal(false);
      };

      const updateDetail = () => {
         const oldDetail = budget.details.find(d => d.id === editingDetailId);
         const diff = parseNumberLike(detailDraft.amount) - parseNumberLike(oldDetail.amount);
         const newExecuted = parseNumberLike(budget.executed) + diff;
         
         const newDetails = budget.details.map(d => d.id === editingDetailId ? detailDraft : d);
         setBudget({...budget, details: newDetails, executed: newExecuted });
         setEditingDetailId(null);
      };

      const removeDetail = (id) => {
         if(!confirm('삭제합니까?')) return;
         const target = budget.details.find(d => d.id === id);
         const newExecuted = Math.max(0, parseNumberLike(budget.executed) - parseNumberLike(target.amount));
         const newDetails = budget.details.filter(d => d.id !== id);
         setBudget({...budget, details: newDetails, executed: newExecuted });
      };

      return (
         <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex justify-between items-center">
               <div><h2 className="text-xl font-bold text-slate-800">예산 집행 현황</h2><p className="text-sm text-slate-500">예산 및 집행 내역 관리</p></div>
               <div className="flex gap-3 items-center">{saveMsg && <span className="text-sm text-blue-600">{saveMsg}</span>}
               <button onClick={onSave} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold flex gap-2"><Icon name="save" className="w-4 h-4"/> 저장하기</button></div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
               <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                  {/* 총 예산 수정 카드 */}
                  <div className="bg-slate-50 p-4 rounded-xl text-center border border-slate-100 relative group">
                     <div className="text-sm text-slate-500 mb-1 flex justify-center gap-2 items-center">
                        총 예산 
                        {!isEditingTotal && (
                           <button 
                             onClick={()=>{setTotalDraft(budget.total); setIsEditingTotal(true)}} 
                             className="ml-2 px-2 py-0.5 text-xs bg-white border border-slate-300 rounded text-slate-600 hover:bg-slate-50 shadow-sm"
                           >
                             수정
                           </button>
                        )}
                     </div>
                     {isEditingTotal ? (
                        <div className="flex flex-col items-center gap-2 mt-1">
                            <input 
                              className="w-32 p-1.5 text-center border border-blue-300 rounded font-bold text-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                              value={totalDraft} 
                              onChange={e=>setTotalDraft(e.target.value)}
                              autoFocus
                            />
                            <div className="flex gap-1">
                                <button onClick={saveTotal} className="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">저장</button>
                                <button onClick={()=>setIsEditingTotal(false)} className="bg-slate-200 text-slate-600 px-3 py-1 rounded text-xs hover:bg-slate-300">취소</button>
                            </div>
                        </div>
                     ) : <div className="text-xl font-bold text-slate-800">{parseNumberLike(budget.total).toLocaleString()} 천원</div>}
                  </div>
                  
                  <div className="bg-blue-50 p-4 rounded-xl text-center border border-blue-100">
                     <div className="text-sm text-blue-600 mb-1">집행액</div>
                     <div className="text-xl font-bold text-blue-700">{parseNumberLike(budget.executed).toLocaleString()} 천원</div>
                  </div>
                  <div className="bg-emerald-50 p-4 rounded-xl text-center border border-emerald-100">
                     <div className="text-sm text-emerald-600 mb-1">잔액 ({100-ratio}%)</div>
                     <div className="text-xl font-bold text-emerald-700">{remaining.toLocaleString()} 천원</div>
                  </div>
               </div>

               {/* 집행률 바 */}
               <div className="mb-6">
                  <div className="flex justify-between text-xs text-slate-500 mb-1"><span>집행률</span><span>{ratio}%</span></div>
                  <div className="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                     <div className="bg-blue-600 h-full transition-all duration-500" style={{width: `${Math.min(ratio, 100)}%`}}></div>
                  </div>
               </div>

               {/* 입력 및 리스트 */}
               <div className="border-t border-slate-100 pt-4">
                  <h3 className="font-bold text-slate-700 mb-3">집행 내역 등록</h3>
                  <div className="flex flex-col md:flex-row gap-2 mb-4">
                     <input ref={dateRef} type="date" className="p-2 border rounded w-full md:w-40 text-slate-600" defaultValue={todayISO()} />
                     <input ref={itemRef} className="flex-1 p-2 border rounded" placeholder="항목명 (예: 회의비)" />
                     <input ref={amountRef} type="number" className="w-full md:w-32 p-2 border rounded" placeholder="금액 (천원)" />
                     <button onClick={addDetail} className="bg-slate-900 text-white px-4 py-2 rounded font-bold hover:bg-slate-800 shrink-0">등록</button>
                  </div>
                  <div className="overflow-x-auto">
                     <table className="w-full text-sm text-left">
                        <thead className="bg-slate-50 border-b"><tr><th className="p-3 w-[120px]">일자</th><th className="p-3">항목</th><th className="p-3 text-right w-[150px]">금액 (천원)</th><th className="p-3 text-center w-[120px]">관리</th></tr></thead>
                        <tbody className="divide-y">
                           {(budget.details||[]).map(d => {
                              const isEdit = editingDetailId === d.id;
                              return (
                                 <tr key={d.id} className={isEdit ? "bg-yellow-50" : ""}>
                                    <td className="p-3 text-slate-600">{isEdit?<input type="date" value={detailDraft.date} onChange={e=>setDetailDraft({...detailDraft, date:e.target.value})} className="border rounded w-full"/> : d.date}</td>
                                    <td className="p-3 font-medium text-slate-800">{isEdit?<input value={detailDraft.item} onChange={e=>setDetailDraft({...detailDraft, item:e.target.value})} className="border rounded w-full"/> : d.item}</td>
                                    <td className="p-3 text-right text-slate-600">{isEdit?<input value={detailDraft.amount} onChange={e=>setDetailDraft({...detailDraft, amount:e.target.value})} className="border rounded w-20 text-right"/> : parseNumberLike(d.amount).toLocaleString()}</td>
                                    <td className="p-3 text-center flex justify-center gap-1">
                                       {isEdit ? (
                                          <><button onClick={updateDetail} className="px-2 py-1 bg-emerald-600 text-white rounded text-xs hover:bg-emerald-700">저장</button>
                                          <button onClick={()=>setEditingDetailId(null)} className="px-2 py-1 bg-slate-300 text-slate-700 rounded text-xs hover:bg-slate-400">취소</button></>
                                       ) : (
                                          <><button onClick={()=>{setEditingDetailId(d.id); setDetailDraft({...d})}} className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">수정</button>
                                          <button onClick={()=>removeDetail(d.id)} className="px-2 py-1 bg-rose-100 text-rose-700 rounded text-xs hover:bg-rose-200">삭제</button></>
                                       )}
                                    </td>
                                 </tr>
                              )
                           })}
                        </tbody>
                     </table>
                  </div>
               </div>
            </div>
         </div>
      );
    };

    // ==========================================
    // 4. 메인 App
    // ==========================================
    const App = () => {
      const [tab, setTab] = useState('dashboard');
      const [municipalData, setMunicipalData] = useState(INITIAL_MUNICIPAL);
      const [univData, setUnivData] = useState(INITIAL_UNIV);
      const [tasks, setTasks] = useState(INITIAL_TASKS);
      const [budget, setBudget] = useState(INITIAL_BUDGET);
      const [saveMsg, setSaveMsg] = useState("");

      useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [tab, municipalData, tasks, budget]);

      useEffect(() => {
        const load = async () => {
          try {
              const s = await db.ref(DB_PATH).get();
              if(s.exists()) {
                 const d = s.val();
                 if(d.municipalIndicators) setMunicipalData(d.municipalIndicators);
                 if(d.univIndicators) setUnivData(d.univIndicators);
                 if(d.tasks) setTasks(d.tasks);
                 if(d.budget) setBudget(d.budget);
              }
          } catch(e) { console.log("로드 실패 (초기 데이터 사용)"); }
        };
        load();
      }, []);

      const handleUpdate = (group, id, field, value) => {
        const num = value === "" ? "" : parseNumberLike(value);
        const targetSetter = group === "지자체" ? setMunicipalData : setUnivData;
        targetSetter(prev => prev.map(item => item.id === id ? { ...item, [field]: num } : item));
      };

      const handleSave = async () => {
        setSaveMsg("저장 중...");
        try {
          await db.ref(DB_PATH).update({
            municipalIndicators: municipalData, univIndicators: univData,
            tasks, budget, updatedAt: new Date().toISOString()
          });
          setSaveMsg("✅ 저장 완료!"); setTimeout(() => setSaveMsg(""), 2000);
        } catch (e) { console.error(e); setSaveMsg("❌ 저장 실패"); }
      };

      // 대시보드 통계
      const allInds = [...municipalData, ...univData];
      const validT = allInds.filter(d => parseNumberLike(d.target) > 0);
      const avgRate = validT.length ? (validT.reduce((acc, cur) => acc + Math.min(((parseNumberLike(cur.sem1)+parseNumberLike(cur.sem2))/parseNumberLike(cur.target))*100, 100), 0) / validT.length).toFixed(1) : 0;
      const budgetRate = parseNumberLike(budget.total) > 0 ? ((parseNumberLike(budget.executed)/parseNumberLike(budget.total))*100).toFixed(1) : 0;

      return (
        <div className="max-w-7xl mx-auto p-6 space-y-6">
          <header className="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-slate-200 gap-4">
            <div>
                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <Icon name="layout-dashboard" className="text-blue-600" /> [2-1] 얼리버드 사업실적관리
                </h1>
                <p className="text-sm text-slate-500 mt-1 ml-8">취업지원센터 사업운영 성과 관리 시스템</p>
            </div>
            
            {/* 탭 네비게이션 */}
            <div className="flex bg-slate-100 p-1 rounded-lg">
               {[{id:'dashboard', label:'대시보드'}, {id:'tasks', label:'세부추진과제'}, {id:'budget', label:'예산관리'}].map(t => (
                  <button key={t.id} onClick={()=>setTab(t.id)} 
                     className={`px-4 py-2 text-sm font-bold rounded-md transition ${tab===t.id ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
                     {t.label}
                  </button>
               ))}
            </div>
          </header>

          {tab === 'dashboard' && (
             <div className="space-y-6">
                {/* ✅ 복구된 지표별 달성 현황 (그래프) */}
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <Icon name="bar-chart-3" className="w-5 h-5 text-blue-600"/> 지표별 달성 현황
                    </h3>
                    <div className="space-y-5">
                        {[...municipalData, ...univData].map(row => {
                            const target = parseNumberLike(row.target);
                            const current = parseNumberLike(row.sem1) + parseNumberLike(row.sem2);
                            const rate = target > 0 ? (current / target) * 100 : 0;
                            const isSubtotal = row.subItem && (row.subItem.includes('소계') || row.subItem.includes('합계'));
                            
                            // 그래프 색상 로직
                            let barColor = 'bg-blue-500';
                            if (rate >= 100) barColor = 'bg-emerald-500';
                            else if (rate === 0) barColor = 'bg-slate-200';
                            else if (rate < 50) barColor = 'bg-orange-400';
                            
                            return (
                                <div key={row.id} className="relative">
                                    <div className="flex justify-between text-sm mb-1.5">
                                        <div className="flex items-center gap-2">
                                            <span className={`text-slate-700 ${isSubtotal ? 'font-bold' : ''}`}>
                                                {row.indicatorName} 
                                            </span>
                                            {row.subItem !== '-' && (
                                                <span className="text-xs px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded border border-slate-200">
                                                    {row.subItem}
                                                </span>
                                            )}
                                        </div>
                                        <div className="text-slate-600 font-medium">
                                            <span className="text-xs text-slate-400 mr-2">목표: {target.toLocaleString()}</span>
                                            {current.toLocaleString()} 
                                            <span className={`ml-2 ${rate >= 100 ? 'text-emerald-600 font-bold' : 'text-slate-500'}`}>
                                                ({rate.toFixed(1)}%)
                                            </span>
                                        </div>
                                    </div>
                                    <div className="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                                        <div className={`h-full rounded-full transition-all duration-500 ${barColor}`} 
                                             style={{ width: `${Math.min(rate, 100)}%` }}>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>

                <div className="flex justify-end">{saveMsg && <span className="text-blue-600 font-bold animate-pulse mr-4 self-center">{saveMsg}</span>}
                <button onClick={handleSave} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-700 flex items-center gap-2"><Icon name="save" className="w-4 h-4"/> 전체 저장하기</button></div>
                
                <IndicatorsTable title="[지자체] 성과목표 달성율" rows={municipalData} group="지자체" onUpdate={handleUpdate} />
                <IndicatorsTable title="[대학] 자율성과지표" rows={univData} group="대학" onUpdate={handleUpdate} />
             </div>
          )}

          {tab === 'tasks' && <TasksView tasks={tasks} setTasks={setTasks} onSave={handleSave} saveMsg={saveMsg} />}
          {tab === 'budget' && <BudgetView budget={budget} setBudget={setBudget} onSave={handleSave} saveMsg={saveMsg} />}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
