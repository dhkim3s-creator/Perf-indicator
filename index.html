<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>[2-1] 얼리버드 취업지원 사업실적관리</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>

<body class="bg-slate-50">
  <div id="root"></div>

  <script>
    const h = React.createElement;

    // =========================
    // Firebase 설정
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDp5-SjGHdLRQ7feRoS-RdKsJI4QFUJKQ0",
      authDomain: "perf-indicator.firebaseapp.com",
      databaseURL: "https://perf-indicator-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "perf-indicator",
      storageBucket: "perf-indicator.firebasestorage.app",
      messagingSenderId: "425708194902",
      appId: "1:425708194902:web:1bd90a680999b8791b3ff7",
      measurementId: "G-8LBV6RBRJP"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const DB_PATH = "earlyBirdManager/v1";

    // =========================
    // 초기 예산 데이터
    // =========================
    const INITIAL_BUDGET = {
      total: 665000,
      executed: 334229,
      details: [
        { id: 1, item: '얼리버드 취업지원 운영비', amount: 334229, date: '2025-06-30', type: '집행' }
      ]
    };

    // 숫자만 추출
    function toNumberSafe(v) {
      const n = Number(String(v ?? "").replace(/[^\d]/g, ""));
      return Number.isFinite(n) ? n : 0;
    }

    function App() {
      const { useEffect, useMemo, useRef, useState } = React;

      const [budget, setBudget] = useState(INITIAL_BUDGET);
      const [loading, setLoading] = useState(true);
      const [saveMsg, setSaveMsg] = useState("");

      // IME(한글/연속입력) 안전: uncontrolled + ref
      const itemRef = useRef(null);
      const amountRef = useRef(null);

      // 수정 상태
      const [editingId, setEditingId] = useState(null);
      const [editDraft, setEditDraft] = useState({ date: "", item: "", amount: "" });

      useEffect(() => {
        let mounted = true;
        (async () => {
          try {
            const snap = await db.ref(DB_PATH).get();
            if (mounted && snap.exists()) {
              const data = snap.val();
              if (data?.budget) setBudget(data.budget);
            }
          } catch (e) {
            console.error(e);
          } finally {
            if (mounted) setLoading(false);
          }
        })();
        return () => { mounted = false; };
      }, []);

      const totalBudgetRatio = useMemo(() => {
        return budget.total > 0 ? ((budget.executed / budget.total) * 100).toFixed(1) : "0.0";
      }, [budget]);

      const saveToFirebase = async () => {
        setSaveMsg("");
        try {
          const snap = await db.ref(DB_PATH).get();
          const prev = snap.exists() ? snap.val() : {};
          const payload = {
            ...prev,
            budget,
            updatedAt: new Date().toISOString()
          };
          await db.ref(DB_PATH).set(payload);
          setSaveMsg("✅ 저장 완료");
          setTimeout(() => setSaveMsg(""), 1500);
        } catch (e) {
          console.error(e);
          setSaveMsg("❌ 저장 실패(Rules 확인)");
          setTimeout(() => setSaveMsg(""), 2500);
        }
      };

      const addExpense = () => {
        const item = (itemRef.current?.value || "").trim();
        const raw = (amountRef.current?.value || "").trim();
        const amount = toNumberSafe(raw);

        if (!item || amount <= 0) return;

        setBudget(prev => ({
          ...prev,
          executed: prev.executed + amount,
          details: [
            ...prev.details,
            {
              id: Date.now(),
              item,
              amount,
              date: new Date().toISOString().slice(0, 10),
              type: "집행"
            }
          ]
        }));

        // 입력값 초기화
        if (itemRef.current) itemRef.current.value = "";
        if (amountRef.current) amountRef.current.value = "";
        if (itemRef.current) itemRef.current.focus();
      };

      const startEdit = (d) => {
        setEditingId(d.id);
        setEditDraft({
          date: d.date || "",
          item: d.item || "",
          amount: String(d.amount ?? "")
        });
      };

      const cancelEdit = () => {
        setEditingId(null);
        setEditDraft({ date: "", item: "", amount: "" });
      };

      const changeEdit = (field, value) => {
        setEditDraft(prev => ({ ...prev, [field]: value }));
      };

      // ✅ 수정 저장: executed는 차액 반영
      const saveEdit = () => {
        if (editingId == null) return;

        const newItem = (editDraft.item || "").trim();
        const newDate = (editDraft.date || "").trim();
        const newAmount = toNumberSafe(editDraft.amount);

        if (!newItem || !newDate || newAmount <= 0) return;

        setBudget(prev => {
          const old = prev.details.find(x => x.id === editingId);
          if (!old) return prev;

          const oldAmount = Number(old.amount) || 0;
          const diff = newAmount - oldAmount;

          return {
            ...prev,
            executed: prev.executed + diff,
            details: prev.details.map(x =>
              x.id === editingId ? { ...x, item: newItem, date: newDate, amount: newAmount } : x
            )
          };
        });

        cancelEdit();
      };

      // ✅ 삭제: executed 차감
      const deleteDetail = (id) => {
        setBudget(prev => {
          const target = prev.details.find(x => x.id === id);
          if (!target) return prev;

          const amt = Number(target.amount) || 0;
          return {
            ...prev,
            executed: Math.max(0, prev.executed - amt),
            details: prev.details.filter(x => x.id !== id)
          };
        });

        if (editingId === id) cancelEdit();
      };

      if (loading) {
        return h("div", { className: "max-w-6xl mx-auto p-6" },
          h("div", { className: "bg-white border border-slate-200 rounded-xl p-6 text-slate-600" },
            "Firebase에서 데이터를 불러오는 중입니다..."
          )
        );
      }

      return h("div", { className: "min-h-screen" },

        // Header
        h("header", { className: "bg-white border-b border-slate-200 sticky top-0 z-10" },
          h("div", { className: "max-w-6xl mx-auto px-4 sm:px-6 lg:px-8" },
            h("div", { className: "flex items-center justify-between h-16" },
              h("div", { className: "flex items-center gap-2" },
                h("div", { className: "w-9 h-9 rounded-lg bg-blue-600 text-white flex items-center justify-center font-bold" }, "↗"),
                h("h1", { className: "text-lg font-bold text-slate-800" }, "[2-1] 얼리버드 취업지원 사업실적관리")
              ),
              h("div", { className: "flex items-center gap-3" },
                saveMsg ? h("span", { className: "text-sm text-slate-500" }, saveMsg) : null,
                h("button", {
                  onClick: saveToFirebase,
                  className: "px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm font-medium"
                }, "저장하기")
              )
            )
          )
        ),

        // Main
        h("main", { className: "max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6" },

          // Summary
          h("div", { className: "bg-white p-6 rounded-xl shadow-sm border border-slate-200" },
            h("h2", { className: "text-xl font-bold text-slate-800 mb-6" }, "예산 집행 현황"),

            h("div", { className: "grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" },
              h("div", { className: "p-4 bg-slate-50 rounded-lg text-center" },
                h("div", { className: "text-sm text-slate-500 mb-1" }, "총 예산"),
                h("div", { className: "text-lg font-bold text-slate-800" }, budget.total.toLocaleString() + " 천원")
              ),
              h("div", { className: "p-4 bg-blue-50 rounded-lg text-center border border-blue-100" },
                h("div", { className: "text-sm text-blue-600 mb-1" }, "집행액 (승인+지출)"),
                h("div", { className: "text-lg font-bold text-blue-700" }, budget.executed.toLocaleString() + " 천원")
              ),
              h("div", { className: "p-4 bg-emerald-50 rounded-lg text-center border border-emerald-100" },
                h("div", { className: "text-sm text-emerald-600 mb-1" }, "잔액"),
                h("div", { className: "text-lg font-bold text-emerald-700" }, (budget.total - budget.executed).toLocaleString() + " 천원")
              )
            ),

            // Add form
            h("h3", { className: "text-sm font-bold text-slate-700 mb-2" }, "집행 내역 등록"),
            h("div", { className: "flex gap-2 items-center" },
              h("input", {
                ref: itemRef,
                type: "text",
                placeholder: "항목명 (예: 캡스톤 재료비)",
                className: "flex-1 p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm",
                autoComplete: "off",
                spellCheck: false
              }),
              h("input", {
                ref: amountRef,
                type: "text",
                inputMode: "numeric",
                placeholder: "금액(천원)",
                className: "w-32 p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm",
                autoComplete: "off",
                spellCheck: false,
                onKeyDown: (e) => { if (e.key === "Enter") addExpense(); }
              }),
              h("button", {
                onClick: addExpense,
                className: "px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 text-sm font-medium"
              }, "등록")
            ),

            // ratio
            h("div", { className: "mt-6" },
              h("div", { className: "text-xs text-slate-500 mb-2" }, "현재 집행률: " + totalBudgetRatio + "%"),
              h("div", { className: "w-full bg-slate-100 rounded-full h-2" },
                h("div", { className: "bg-blue-600 h-2 rounded-full", style: { width: Math.min(Number(totalBudgetRatio), 100) + "%" } })
              )
            )
          ),

          // ✅ Recent table (수정/삭제가 반드시 보이도록 강제)
          h("div", { className: "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" },
            h("div", { className: "p-4 border-b border-slate-100 bg-slate-50" },
              h("h3", { className: "font-semibold text-slate-700" }, "최근 집행 내역 (수정/삭제 가능)")
            ),

            // ✅ 여기 중요: overflow-x-auto + min-w
            h("div", { className: "overflow-x-auto" },
              h("table", { className: "w-full text-sm min-w-[980px]" },
                h("thead", { className: "bg-white text-slate-500 border-b border-slate-100" },
                  h("tr", null,
                    h("th", { className: "px-6 py-3 text-left w-[140px]" }, "일자"),
                    h("th", { className: "px-6 py-3 text-left" }, "항목"),
                    h("th", { className: "px-6 py-3 text-right w-[160px]" }, "금액 (천원)"),
                    h("th", { className: "px-6 py-3 text-center w-[90px]" }, "구분"),
                    h("th", { className: "px-6 py-3 text-center w-[220px]" }, "관리")
                  )
                ),

                h("tbody", { className: "divide-y divide-slate-100" },
                  budget.details.map(d => {
                    const isEditing = editingId === d.id;

                    return h("tr", { key: d.id, className: isEditing ? "bg-yellow-50/60" : "" },

                      // date
                      h("td", { className: "px-6 py-3 text-slate-600" },
                        isEditing
                          ? h("input", {
                              type: "date",
                              className: "p-1 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm",
                              value: editDraft.date || "",
                              onChange: (e) => changeEdit("date", e.target.value)
                            })
                          : d.date
                      ),

                      // item
                      h("td", { className: "px-6 py-3 text-slate-800 font-medium" },
                        isEditing
                          ? h("input", {
                              type: "text",
                              className: "w-full p-1 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm",
                              value: editDraft.item || "",
                              onChange: (e) => changeEdit("item", e.target.value)
                            })
                          : d.item
                      ),

                      // amount
                      h("td", { className: "px-6 py-3 text-right text-slate-600" },
                        isEditing
                          ? h("input", {
                              type: "text",
                              inputMode: "numeric",
                              className: "w-28 text-right p-1 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm",
                              value: String(editDraft.amount ?? ""),
                              onChange: (e) => changeEdit("amount", e.target.value)
                            })
                          : d.amount.toLocaleString()
                      ),

                      // type
                      h("td", { className: "px-6 py-3 text-center" },
                        h("span", { className: "px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs" }, d.type)
                      ),

                      // actions (✅ 여기 반드시 보임)
                      h("td", { className: "px-6 py-3 text-center" },
                        isEditing
                          ? h("div", { className: "flex justify-center gap-2" },
                              h("button", {
                                onClick: saveEdit,
                                className: "px-3 py-1.5 text-xs rounded-lg bg-emerald-600 text-white hover:bg-emerald-700"
                              }, "저장"),
                              h("button", {
                                onClick: cancelEdit,
                                className: "px-3 py-1.5 text-xs rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300"
                              }, "취소")
                            )
                          : h("div", { className: "flex justify-center gap-2" },
                              h("button", {
                                onClick: () => startEdit(d),
                                className: "px-3 py-1.5 text-xs rounded-lg bg-blue-600 text-white hover:bg-blue-700"
                              }, "수정"),
                              h("button", {
                                onClick: () => deleteDetail(d.id),
                                className: "px-3 py-1.5 text-xs rounded-lg bg-rose-600 text-white hover:bg-rose-700"
                              }, "삭제")
                            )
                      )
                    );
                  })
                )
              )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(h(App));
  </script>
</body>
</html>
